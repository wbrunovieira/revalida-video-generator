---
# Download AI models for video generation
# This task downloads the main model: Wan 2.2
# Run with: ansible-playbook playbook.yml --tags download-models

- name: Display model download banner
  debug:
    msg: |
      ==========================================
      ðŸ“¥ DOWNLOADING AI MODELS
      ==========================================
      This will download ~20GB of models:
      1. Wan 2.2 (~20GB)

      This may take 15-30 minutes depending on connection
      ==========================================

# ============================================
# CONFIGURE HUGGING FACE CACHE
# ============================================
- name: Remove old Hugging Face cache from home directory
  file:
    path: /home/ubuntu/.cache/huggingface
    state: absent
  become_user: ubuntu
  tags: [download-models]

- name: Create Hugging Face cache directory in /mnt/models
  file:
    path: "{{ models_dir }}/.cache"
    state: directory
    owner: ubuntu
    group: ubuntu
    mode: '0755'
  tags: [download-models]

- name: Set HF_HOME environment variable in ubuntu's profile
  lineinfile:
    path: /home/ubuntu/.profile
    line: 'export HF_HOME=/mnt/models/.cache'
    create: yes
    owner: ubuntu
    group: ubuntu
  tags: [download-models]

# ============================================
# WAN 2.2 MODEL
# ============================================
- name: Create Wan 2.2 directory
  file:
    path: "{{ models_dir }}/Wan2.2"
    state: directory
    owner: ubuntu
    group: ubuntu
    mode: '0755'
  tags: [download-models]

- name: Download Wan 2.2 complete model
  shell: |
    export HF_HOME={{ models_dir }}/.cache
    . {{ app_dir }}/venv/bin/activate
    huggingface-cli download Wan-AI/Wan2.2-T2V-A14B \
      --local-dir {{ models_dir }}/Wan2.2
  become_user: ubuntu
  args:
    executable: /bin/bash
    creates: "{{ models_dir }}/Wan2.2/models_t5_umt5-xxl-enc-bf16.pth"
  tags: [download-models]

- name: Display Wan 2.2 download complete
  debug:
    msg: "âœ… Wan 2.2 downloaded successfully"
  tags: [download-models]

# ============================================
# FINAL STATUS
# ============================================
- name: Get models directory size
  shell: du -sh {{ models_dir }}/* 2>/dev/null || echo "0"
  register: models_size
  changed_when: false
  tags: [download-models]

- name: Display final download status
  debug:
    msg: |
      ==========================================
      âœ… ALL MODELS DOWNLOADED SUCCESSFULLY
      ==========================================
      Models location: {{ models_dir }}
      {{ models_size.stdout }}
      ==========================================

      See documentation in docs/ for usage instructions:
      - docs/WAN22.md
      ==========================================
  tags: [download-models]
