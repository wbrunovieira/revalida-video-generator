---
# Test HunyuanVideo setup and generate first video
# Run with: ansible-playbook playbook.yml --tags test-hunyuan

- name: Check HunyuanVideo model directory structure
  shell: |
    echo "=== HunyuanVideo Directory Structure ==="
    ls -lh /mnt/models/HunyuanVideo/
    echo ""
    echo "=== Subdirectories ==="
    find /mnt/models/HunyuanVideo -maxdepth 2 -type d
    echo ""
    echo "=== Model files (first 20) ==="
    find /mnt/models/HunyuanVideo -type f | head -20
    echo ""
    echo "=== Total size ==="
    du -sh /mnt/models/HunyuanVideo/
  register: model_structure
  become_user: ubuntu
  tags: [test-hunyuan, never]

- name: Display model structure
  debug:
    msg: "{{ model_structure.stdout_lines }}"
  tags: [test-hunyuan, never]

- name: Create HunyuanVideo test script
  copy:
    dest: /mnt/output/test_hunyuan.sh
    content: |
      #!/bin/bash
      # Test HunyuanVideo with 4 GPUs

      cd /mnt/models/HunyuanVideo/code
      source /home/ubuntu/video-generation/venv/bin/activate

      # Disable xformers to avoid compatibility issues
      export XFORMERS_DISABLED=1

      echo "üé¨ Testing HunyuanVideo with 4 GPUs..."
      echo "This will generate a 5-second 720p video"
      echo ""

      # HunyuanVideo uses a specific directory structure
      MODEL_PATH="/mnt/models/HunyuanVideo/hunyuan-video-t2v-720p"

      if [ ! -d "$MODEL_PATH" ]; then
        echo "‚ùå Error: Model directory not found: $MODEL_PATH"
        echo "Available directories:"
        ls -la /mnt/models/HunyuanVideo/
        exit 1
      fi

      echo "Using model path: $MODEL_PATH"
      echo ""

      # Run single-GPU first to test basic functionality
      # Multi-GPU with xfuser requires xformers which has compatibility issues
      python3 sample_video.py \
        --model-base /mnt/models/HunyuanVideo \
        --dit hunyuan-video-t2v-720p/transformers \
        --video-size 720 1280 \
        --video-length 129 \
        --infer-steps 30 \
        --prompt "Italian doctor in white coat examining medical charts in modern hospital, professional HD quality, cinematic lighting" \
        --flow-reverse \
        --use-cpu-offload \
        --seed 42 \
        --save-path /mnt/output/test_hunyuan.mp4

      echo ""
      echo "‚úÖ Video saved to: /mnt/output/test_hunyuan.mp4"
      ls -lh /mnt/output/test_hunyuan.mp4
    mode: '0755'
    owner: ubuntu
    group: ubuntu
  tags: [test-hunyuan, never]

- name: Display test instructions
  debug:
    msg: |
      ==========================================
      üìã HUNYUANVIDEO TEST READY
      ==========================================

      SSH into server and run:
      /mnt/output/test_hunyuan.sh

      This will:
      1. Auto-detect model location
      2. Generate 5-second 720p video
      3. Use all 4 GPUs (~8 minutes)
      4. Save to /mnt/output/test_hunyuan.mp4

      Monitor GPUs with:
      watch -n 1 nvidia-smi
      ==========================================
  tags: [test-hunyuan, never]
