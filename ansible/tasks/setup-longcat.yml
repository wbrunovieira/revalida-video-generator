---
# Setup LongCat-Video for T2V, I2V, and Video-Continuation
# Run with: ansible-playbook playbook.yml --tags setup-longcat

- name: Display LongCat setup banner
  debug:
    msg: |
      ==========================================
      ðŸ± SETTING UP LONGCAT-VIDEO
      ==========================================
      Features:
      - 13.6B parameters (dense architecture)
      - Text-to-Video, Image-to-Video, Video-Continuation
      - Long video generation (minutes-long)
      - 720p, 30fps output
      - Multi-GPU with context parallelism
      - FlashAttention-2 support
      ==========================================

# ============================================
# INSTALL LONGCAT DEPENDENCIES
# ============================================
- name: Install LongCat base dependencies
  pip:
    name:
      - ninja
      - psutil
      - packaging
      - einops
      - omegaconf
      - decord
      - imageio
      - imageio-ffmpeg
    virtualenv: "{{ app_dir }}/venv"
  become_user: ubuntu
  tags: [setup-longcat]

- name: Check if flash-attn is installed
  shell: |
    source {{ app_dir }}/venv/bin/activate
    pip show flash-attn || echo "not_installed"
  register: flash_attn_check
  become_user: ubuntu
  changed_when: false
  tags: [setup-longcat]
  args:
    executable: /bin/bash

- name: Install flash-attn if not present
  pip:
    name: flash_attn==2.7.4.post1
    virtualenv: "{{ app_dir }}/venv"
  become_user: ubuntu
  when: "'not_installed' in flash_attn_check.stdout"
  tags: [setup-longcat]

# ============================================
# CLONE LONGCAT REPOSITORY
# ============================================
- name: Clone LongCat-Video repository
  git:
    repo: https://github.com/meituan-longcat/LongCat-Video.git
    dest: "{{ models_dir }}/LongCat-Video-code"
    version: main
    force: yes
  become_user: ubuntu
  tags: [setup-longcat]

- name: Install LongCat requirements (excluding flash-attn)
  shell: |
    source {{ app_dir }}/venv/bin/activate
    cd {{ models_dir }}/LongCat-Video-code
    # Install requirements excluding flash-attn (already installed separately)
    grep -v "flash-attn" requirements.txt | pip install -r /dev/stdin
  become_user: ubuntu
  tags: [setup-longcat]
  args:
    executable: /bin/bash
  ignore_errors: yes

- name: Ensure flash-attn is installed (pre-built wheel)
  shell: |
    source {{ app_dir }}/venv/bin/activate
    # Check if already installed
    if pip show flash-attn > /dev/null 2>&1; then
      echo "flash-attn already installed"
    else
      # Install pre-built wheel for PyTorch 2.6 + CUDA 12.4
      pip install flash-attn --no-build-isolation
    fi
  become_user: ubuntu
  tags: [setup-longcat]
  args:
    executable: /bin/bash
  ignore_errors: yes

# ============================================
# DOWNLOAD LONGCAT MODEL
# ============================================
- name: Check if LongCat model exists
  stat:
    path: "{{ models_dir }}/LongCat-Video/config.json"
  register: longcat_model_check
  tags: [setup-longcat]

- name: Download LongCat-Video model (~27GB)
  shell: |
    source {{ app_dir }}/venv/bin/activate
    cd {{ models_dir }}
    echo "ðŸ“¥ Downloading LongCat-Video (~27GB, will take 20-40 minutes)..."
    huggingface-cli download meituan-longcat/LongCat-Video --local-dir LongCat-Video
  become_user: ubuntu
  when: not longcat_model_check.stat.exists
  tags: [setup-longcat]
  args:
    executable: /bin/bash
  async: 7200  # 2 hour timeout
  poll: 60    # Check every 60 seconds

- name: Verify model downloaded successfully
  stat:
    path: "{{ models_dir }}/LongCat-Video/config.json"
  register: longcat_final_check
  tags: [setup-longcat]

- name: Display model download status
  debug:
    msg: |
      LongCat-Video model: {{ 'Downloaded âœ…' if longcat_final_check.stat.exists else 'Failed âŒ' }}
      Location: {{ models_dir }}/LongCat-Video/
  tags: [setup-longcat]

# ============================================
# CREATE HELPER SCRIPTS
# ============================================
- name: Create LongCat T2V helper script
  copy:
    dest: "{{ app_dir }}/longcat_t2v.sh"
    content: |
      #!/bin/bash
      # LongCat Text-to-Video generation
      # Usage: longcat_t2v.sh "your prompt here" [num_gpus]

      PROMPT="${1:-A cat walking on the beach at sunset}"
      NUM_GPUS="${2:-4}"

      source {{ app_dir }}/venv/bin/activate
      cd {{ models_dir }}/LongCat-Video-code

      echo "ðŸ± Generating video with LongCat..."
      echo "Prompt: $PROMPT"
      echo "GPUs: $NUM_GPUS"
      echo ""

      # Backup original script
      cp run_demo_text_to_video.py run_demo_text_to_video.py.bak

      # Replace prompt in script (escape special characters for sed)
      ESCAPED_PROMPT=$(echo "$PROMPT" | sed 's/[&/\]/\\&/g' | sed "s/'/\\\\'/g")
      sed -i "s|prompt = \".*\"|prompt = \"$ESCAPED_PROMPT\"|" run_demo_text_to_video.py

      # Run generation
      torchrun --nproc_per_node=$NUM_GPUS run_demo_text_to_video.py \
        --context_parallel_size=$NUM_GPUS \
        --checkpoint_dir={{ models_dir }}/LongCat-Video

      # Restore original script
      mv run_demo_text_to_video.py.bak run_demo_text_to_video.py

      # Move outputs to /mnt/output with timestamp
      TIMESTAMP=$(date +%Y%m%d_%H%M%S)
      for f in output_t2v*.mp4; do
        if [ -f "$f" ]; then
          mv "$f" "{{ output_dir }}/longcat_${TIMESTAMP}_${f}"
          echo "âœ… Saved: {{ output_dir }}/longcat_${TIMESTAMP}_${f}"
        fi
      done

      echo ""
      echo "âœ… Done! Check {{ output_dir }}/"
      ls -la {{ output_dir }}/longcat_*.mp4 2>/dev/null | tail -5
    mode: '0755'
    owner: ubuntu
    group: ubuntu
  tags: [setup-longcat]

- name: Create LongCat I2V helper script
  copy:
    dest: "{{ app_dir }}/longcat_i2v.sh"
    content: |
      #!/bin/bash
      # LongCat Image-to-Video generation
      # Usage: longcat_i2v.sh "image_path" "your prompt here" [num_gpus]

      IMAGE_PATH="${1}"
      PROMPT="${2:-A person walking forward}"
      NUM_GPUS="${3:-4}"

      if [ -z "$IMAGE_PATH" ]; then
        echo "Usage: longcat_i2v.sh <image_path> [prompt] [num_gpus]"
        echo "Example: longcat_i2v.sh /mnt/output/character.png 'Doctor walking in hospital'"
        exit 1
      fi

      source {{ app_dir }}/venv/bin/activate
      cd {{ models_dir }}/LongCat-Video-code

      echo "ðŸ± Generating I2V with LongCat..."
      echo "Image: $IMAGE_PATH"
      echo "Prompt: $PROMPT"
      echo "GPUs: $NUM_GPUS"
      echo ""

      # Backup original script
      cp run_demo_image_to_video.py run_demo_image_to_video.py.bak

      # Replace prompt and image_path in script
      ESCAPED_PROMPT=$(echo "$PROMPT" | sed 's/[&/\]/\\&/g' | sed "s/'/\\\\'/g")
      ESCAPED_IMAGE=$(echo "$IMAGE_PATH" | sed 's/[&/\]/\\&/g')
      sed -i "s|prompt = \".*\"|prompt = \"$ESCAPED_PROMPT\"|" run_demo_image_to_video.py
      sed -i "s|image_path = \".*\"|image_path = \"$ESCAPED_IMAGE\"|" run_demo_image_to_video.py

      # Run generation
      torchrun --nproc_per_node=$NUM_GPUS run_demo_image_to_video.py \
        --context_parallel_size=$NUM_GPUS \
        --checkpoint_dir={{ models_dir }}/LongCat-Video

      # Restore original script
      mv run_demo_image_to_video.py.bak run_demo_image_to_video.py

      # Move outputs to /mnt/output with timestamp
      TIMESTAMP=$(date +%Y%m%d_%H%M%S)
      for f in output_i2v*.mp4; do
        if [ -f "$f" ]; then
          mv "$f" "{{ output_dir }}/longcat_i2v_${TIMESTAMP}_${f}"
          echo "âœ… Saved: {{ output_dir }}/longcat_i2v_${TIMESTAMP}_${f}"
        fi
      done

      echo ""
      echo "âœ… Done! Check {{ output_dir }}/"
      ls -la {{ output_dir }}/longcat_i2v_*.mp4 2>/dev/null | tail -5
    mode: '0755'
    owner: ubuntu
    group: ubuntu
  tags: [setup-longcat]

- name: Create LongCat Video-Continuation helper script
  copy:
    dest: "{{ app_dir }}/longcat_continue.sh"
    content: |
      #!/bin/bash
      # LongCat Video-Continuation generation
      # Usage: longcat_continue.sh "video_path" "your prompt here" [num_gpus]

      VIDEO_PATH="${1}"
      PROMPT="${2:-Continue the video naturally}"
      NUM_GPUS="${3:-4}"

      if [ -z "$VIDEO_PATH" ]; then
        echo "Usage: longcat_continue.sh <video_path> [prompt] [num_gpus]"
        echo "Example: longcat_continue.sh /mnt/output/scene1.mp4 'Doctor continues explaining'"
        exit 1
      fi

      source {{ app_dir }}/venv/bin/activate
      cd {{ models_dir }}/LongCat-Video-code

      echo "ðŸ± Continuing video with LongCat..."
      echo "Video: $VIDEO_PATH"
      echo "Prompt: $PROMPT"
      echo "GPUs: $NUM_GPUS"
      echo ""

      # Backup original script
      cp run_demo_video_continuation.py run_demo_video_continuation.py.bak

      # Replace prompt and video_path in script
      ESCAPED_PROMPT=$(echo "$PROMPT" | sed 's/[&/\]/\\&/g' | sed "s/'/\\\\'/g")
      ESCAPED_VIDEO=$(echo "$VIDEO_PATH" | sed 's/[&/\]/\\&/g')
      sed -i "s|prompt = \".*\"|prompt = \"$ESCAPED_PROMPT\"|" run_demo_video_continuation.py
      sed -i "s|video_path = \".*\"|video_path = \"$ESCAPED_VIDEO\"|" run_demo_video_continuation.py

      # Run generation
      torchrun --nproc_per_node=$NUM_GPUS run_demo_video_continuation.py \
        --context_parallel_size=$NUM_GPUS \
        --checkpoint_dir={{ models_dir }}/LongCat-Video

      # Restore original script
      mv run_demo_video_continuation.py.bak run_demo_video_continuation.py

      # Move outputs to /mnt/output with timestamp
      TIMESTAMP=$(date +%Y%m%d_%H%M%S)
      for f in output_continuation*.mp4 output_vc*.mp4; do
        if [ -f "$f" ]; then
          mv "$f" "{{ output_dir }}/longcat_continue_${TIMESTAMP}_${f}"
          echo "âœ… Saved: {{ output_dir }}/longcat_continue_${TIMESTAMP}_${f}"
        fi
      done

      echo ""
      echo "âœ… Done! Check {{ output_dir }}/"
      ls -la {{ output_dir }}/longcat_continue_*.mp4 2>/dev/null | tail -5
    mode: '0755'
    owner: ubuntu
    group: ubuntu
  tags: [setup-longcat]

- name: Create LongCat Long-Video helper script
  copy:
    dest: "{{ app_dir }}/longcat_long.sh"
    content: |
      #!/bin/bash
      # LongCat Long-Video generation (minutes-long)
      # Usage: longcat_long.sh "your prompt here" [num_gpus]

      PROMPT="${1:-A doctor explaining medical procedure in hospital}"
      NUM_GPUS="${2:-4}"

      source {{ app_dir }}/venv/bin/activate
      cd {{ models_dir }}/LongCat-Video-code

      echo "ðŸ± Generating LONG video with LongCat..."
      echo "Prompt: $PROMPT"
      echo "GPUs: $NUM_GPUS"
      echo "âš ï¸  This may take several minutes..."
      echo ""

      # Backup original script
      cp run_demo_long_video.py run_demo_long_video.py.bak

      # Replace prompt in script
      ESCAPED_PROMPT=$(echo "$PROMPT" | sed 's/[&/\]/\\&/g' | sed "s/'/\\\\'/g")
      sed -i "s|prompt = \".*\"|prompt = \"$ESCAPED_PROMPT\"|" run_demo_long_video.py

      # Run generation
      torchrun --nproc_per_node=$NUM_GPUS run_demo_long_video.py \
        --context_parallel_size=$NUM_GPUS \
        --checkpoint_dir={{ models_dir }}/LongCat-Video

      # Restore original script
      mv run_demo_long_video.py.bak run_demo_long_video.py

      # Move outputs to /mnt/output with timestamp
      TIMESTAMP=$(date +%Y%m%d_%H%M%S)
      for f in output_long*.mp4; do
        if [ -f "$f" ]; then
          mv "$f" "{{ output_dir }}/longcat_long_${TIMESTAMP}_${f}"
          echo "âœ… Saved: {{ output_dir }}/longcat_long_${TIMESTAMP}_${f}"
        fi
      done

      echo ""
      echo "âœ… Done! Check {{ output_dir }}/"
      ls -la {{ output_dir }}/longcat_long_*.mp4 2>/dev/null | tail -5
    mode: '0755'
    owner: ubuntu
    group: ubuntu
  tags: [setup-longcat]

# ============================================
# FINAL STATUS
# ============================================
- name: Display LongCat setup complete
  debug:
    msg: |
      ==========================================
      âœ… LONGCAT-VIDEO SETUP COMPLETE
      ==========================================
      Code: {{ models_dir }}/LongCat-Video-code/
      Model: {{ models_dir }}/LongCat-Video/

      Helper Scripts:
      - ~/video-generation/longcat_t2v.sh "prompt"      # Text-to-Video
      - ~/video-generation/longcat_i2v.sh img "prompt"  # Image-to-Video
      - ~/video-generation/longcat_continue.sh vid "prompt"  # Video-Continuation
      - ~/video-generation/longcat_long.sh "prompt"     # Long Video

      Examples:
      ~/video-generation/longcat_t2v.sh "Doctor in white coat explaining procedure"
      ~/video-generation/longcat_i2v.sh /mnt/output/doctor.png "Doctor walking in hospital"
      ~/video-generation/longcat_continue.sh /mnt/output/scene1.mp4 "Doctor continues speaking"
      ==========================================
  tags: [setup-longcat]
