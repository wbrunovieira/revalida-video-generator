---
# Fix Ovi helper script and dependencies
# Run with: ansible-playbook playbook.yml --tags fix-ovi-helper

# ============================================
# FIX DEPENDENCIES FIRST
# ============================================
- name: Remove incompatible xformers
  pip:
    name: xformers
    state: absent
    virtualenv: "{{ app_dir }}/venv"
  become_user: ubuntu
  tags: [fix-ovi-helper]
  ignore_errors: yes

- name: Install missing Ovi dependencies
  pip:
    name:
      - einops
      - omegaconf
      - decord
      - imageio
      - imageio-ffmpeg
      - soundfile
      - librosa
    virtualenv: "{{ app_dir }}/venv"
  become_user: ubuntu
  tags: [fix-ovi-helper]

- name: Install wheel and ninja (required for flash-attn build)
  pip:
    name:
      - wheel
      - ninja
      - packaging
    virtualenv: "{{ app_dir }}/venv"
  become_user: ubuntu
  tags: [fix-ovi-helper]

- name: Uninstall incompatible flash-attn
  pip:
    name: flash-attn
    state: absent
    virtualenv: "{{ app_dir }}/venv"
  become_user: ubuntu
  tags: [fix-ovi-helper]
  ignore_errors: yes

- name: Install Flash Attention 2 (pre-built wheel for PyTorch 2.6 + CUDA 12.x)
  shell: |
    source {{ app_dir }}/venv/bin/activate
    pip uninstall flash-attn -y 2>/dev/null || true
    # Use pre-built wheel matching PyTorch 2.6.0+cu124 with CXX11 ABI=False
    pip install https://github.com/Dao-AILab/flash-attention/releases/download/v2.7.4.post1/flash_attn-2.7.4.post1+cu12torch2.6cxx11abiFALSE-cp310-cp310-linux_x86_64.whl
  become_user: ubuntu
  tags: [fix-ovi-helper]
  ignore_errors: yes
  args:
    executable: /bin/bash

- name: Display dependency fix status
  debug:
    msg: |
      ‚úÖ Dependencies fixed:
      - Removed incompatible xformers
      - Installed einops, omegaconf, decord, etc.
  tags: [fix-ovi-helper]

# ============================================
# FIX MODEL PATHS (symlinks if model in /mnt/output)
# ============================================
- name: Check if Ovi model exists in /mnt/output
  stat:
    path: /mnt/output/Ovi
  register: ovi_in_output
  tags: [fix-ovi-helper]

- name: Check if Ovi model exists in /mnt/models
  stat:
    path: "{{ models_dir }}/Ovi"
  register: ovi_in_models
  tags: [fix-ovi-helper]

- name: Create symlink for Ovi model (output -> models)
  file:
    src: /mnt/output/Ovi
    dest: "{{ models_dir }}/Ovi"
    state: link
    owner: ubuntu
    group: ubuntu
  when: ovi_in_output.stat.exists and not ovi_in_models.stat.exists
  tags: [fix-ovi-helper]

- name: Check if Ovi-code exists in /mnt/output
  stat:
    path: /mnt/output/Ovi-code
  register: ovi_code_in_output
  tags: [fix-ovi-helper]

- name: Check if Ovi-code exists in /mnt/models
  stat:
    path: "{{ models_dir }}/Ovi-code"
  register: ovi_code_in_models
  tags: [fix-ovi-helper]

- name: Create symlink for Ovi-code (output -> models)
  file:
    src: /mnt/output/Ovi-code
    dest: "{{ models_dir }}/Ovi-code"
    state: link
    owner: ubuntu
    group: ubuntu
  when: ovi_code_in_output.stat.exists and not ovi_code_in_models.stat.exists
  tags: [fix-ovi-helper]

- name: Display symlink status
  debug:
    msg: |
      Ovi model symlinks:
      - /mnt/models/Ovi -> {{ '/mnt/output/Ovi' if ovi_in_output.stat.exists else 'Not found' }}
      - /mnt/models/Ovi-code -> {{ '/mnt/output/Ovi-code' if ovi_code_in_output.stat.exists else 'Not found' }}
  tags: [fix-ovi-helper]

# ============================================
# FIX FP8 CHECKPOINT PATH
# ============================================
- name: Check if FP8 weights in root of Ovi dir
  stat:
    path: "{{ models_dir }}/Ovi/model_fp8_e4m3fn.safetensors"
  register: fp8_in_root
  tags: [fix-ovi-helper]

- name: Check if FP8 weights in Ovi/Ovi subdir
  stat:
    path: "{{ models_dir }}/Ovi/Ovi/model_fp8_e4m3fn.safetensors"
  register: fp8_in_subdir
  tags: [fix-ovi-helper]

- name: Move FP8 weights to correct location (Ovi/Ovi/)
  command: mv "{{ models_dir }}/Ovi/model_fp8_e4m3fn.safetensors" "{{ models_dir }}/Ovi/Ovi/model_fp8_e4m3fn.safetensors"
  become_user: ubuntu
  when: fp8_in_root.stat.exists and not fp8_in_subdir.stat.exists
  tags: [fix-ovi-helper]

- name: Display FP8 fix status
  debug:
    msg: |
      FP8 checkpoint location fixed:
      - Expected: {{ models_dir }}/Ovi/Ovi/model_fp8_e4m3fn.safetensors
      - Status: {{ 'Already correct' if fp8_in_subdir.stat.exists else ('Moved' if fp8_in_root.stat.exists else 'Not found') }}
  tags: [fix-ovi-helper]

# ============================================
# FIX HELPER SCRIPTS
# ============================================
- name: Fix Ovi helper script with correct prompt handling
  copy:
    dest: "{{ app_dir }}/ovi_generate.sh"
    content: |
      #!/bin/bash
      # Ovi Video+Audio Generation Helper (FIXED)
      # Usage: ./ovi_generate.sh "Your prompt here. Audio: Your audio description"

      cd {{ models_dir }}/Ovi-code
      source {{ app_dir }}/venv/bin/activate

      PROMPT="${1:-Italian doctor in white coat examining medical charts. Audio: Professional medical office ambiance}"

      echo "üé¨ Generating video+audio with Ovi..."
      echo "Prompt: $PROMPT"
      echo ""

      # Create temporary config with user's prompt
      TEMP_CONFIG="/tmp/ovi_temp_config_$$.yaml"

      cat > "$TEMP_CONFIG" << EOF
      # Temporary Ovi Configuration
      model_name: "720x720_5s"
      output_dir: "/mnt/output"
      ckpt_dir: "/mnt/models/Ovi"

      # Generation Quality
      sample_steps: 50
      solver_name: "unipc"
      shift: 5.0
      seed: 42

      # Guidance
      audio_guidance_scale: 3.0
      video_guidance_scale: 4.0
      slg_layer: 11

      # Performance for 24GB VRAM
      sp_size: 1
      cpu_offload: True
      fp8: True

      # User's prompt
      text_prompt: "$PROMPT"
      mode: "t2v"
      video_frame_height_width: [720, 720]
      each_example_n_times: 1

      # Quality control
      video_negative_prompt: "jitter, bad hands, blur, distortion, deformed"
      audio_negative_prompt: "robotic, muffled, echo, distorted, unclear"
      EOF

      # Run inference with temporary config
      python3 inference.py --config-file "$TEMP_CONFIG"

      # Cleanup
      rm -f "$TEMP_CONFIG"

      echo ""
      echo "‚úÖ Generation complete! Check /mnt/output/"
      ls -lh /mnt/output/*.mp4 | tail -5
    mode: '0755'
    owner: ubuntu
    group: ubuntu
  tags: [fix-ovi-helper]

- name: Create Ovi I2V (Image-to-Video) helper script
  copy:
    dest: "{{ app_dir }}/ovi_i2v.sh"
    content: |
      #!/bin/bash
      # Ovi Image-to-Video Generation Helper
      # Usage: ./ovi_i2v.sh <image_path> "Your prompt here. Audio: <S>Speech text<E> Audio description"
      #
      # Example:
      #   ./ovi_i2v.sh /mnt/output/doctor.png "Doctor speaking to camera. Audio: <S>Buongiorno, sono il Dottor Rossi.<E> Professional office ambiance"

      cd {{ models_dir }}/Ovi-code
      source {{ app_dir }}/venv/bin/activate

      # Check arguments
      if [ -z "$1" ]; then
          echo "‚ùå Error: Image path required"
          echo ""
          echo "Usage: ./ovi_i2v.sh <image_path> \"prompt with Audio: description\""
          echo ""
          echo "Examples:"
          echo "  ./ovi_i2v.sh /mnt/output/doctor.png \"Doctor speaking. Audio: <S>Hello, I am Dr. Smith<E> Office sounds\""
          echo "  ./ovi_i2v.sh ~/my_character.jpg \"Person walking in park. Audio: Birds chirping, footsteps\""
          exit 1
      fi

      IMAGE_PATH="$1"
      PROMPT="${2:-Person speaking to camera. Audio: <S>Hello, welcome to my video.<E> Soft background music}"

      # Verify image exists
      if [ ! -f "$IMAGE_PATH" ]; then
          echo "‚ùå Error: Image not found: $IMAGE_PATH"
          exit 1
      fi

      echo "=========================================="
      echo "üé¨ OVI IMAGE-TO-VIDEO (I2V)"
      echo "=========================================="
      echo "üì∑ Image: $IMAGE_PATH"
      echo "üìù Prompt: $PROMPT"
      echo "=========================================="
      echo ""

      # Create temporary config for I2V
      TEMP_CONFIG="/tmp/ovi_i2v_config_$$.yaml"

      cat > "$TEMP_CONFIG" << EOF
      # Ovi I2V Configuration
      model_name: "720x720_5s"
      output_dir: "/mnt/output"
      ckpt_dir: "/mnt/models/Ovi"

      # Generation Quality
      sample_steps: 50
      solver_name: "unipc"
      shift: 5.0
      seed: 42

      # Guidance
      audio_guidance_scale: 3.0
      video_guidance_scale: 4.0
      slg_layer: 11

      # Performance for 24GB VRAM
      sp_size: 1
      cpu_offload: True
      fp8: True

      # I2V Mode - Image as first frame
      mode: "i2v"
      image_prompt: "$IMAGE_PATH"
      text_prompt: "$PROMPT"
      each_example_n_times: 1

      # Quality control
      video_negative_prompt: "jitter, bad hands, blur, distortion, deformed"
      audio_negative_prompt: "robotic, muffled, echo, distorted, unclear"
      EOF

      echo "üöÄ Starting I2V generation..."
      echo ""

      # Run inference
      python3 inference.py --config-file "$TEMP_CONFIG"

      # Cleanup
      rm -f "$TEMP_CONFIG"

      echo ""
      echo "=========================================="
      echo "‚úÖ I2V GENERATION COMPLETE!"
      echo "=========================================="
      echo "Output videos:"
      ls -lh /mnt/output/*.mp4 2>/dev/null | tail -5
      echo "=========================================="
    mode: '0755'
    owner: ubuntu
    group: ubuntu
  tags: [fix-ovi-helper]

- name: Create Ovi I2V 10-second helper script
  copy:
    dest: "{{ app_dir }}/ovi_i2v_10s.sh"
    content: |
      #!/bin/bash
      # Ovi Image-to-Video 10-Second Generation
      # Usage: ./ovi_i2v_10s.sh <image_path> "Your prompt. Audio: description"

      cd {{ models_dir }}/Ovi-code
      source {{ app_dir }}/venv/bin/activate

      if [ -z "$1" ]; then
          echo "‚ùå Usage: ./ovi_i2v_10s.sh <image_path> \"prompt\""
          exit 1
      fi

      IMAGE_PATH="$1"
      PROMPT="${2:-Person speaking. Audio: <S>Welcome to the presentation<E> Background music}"

      if [ ! -f "$IMAGE_PATH" ]; then
          echo "‚ùå Image not found: $IMAGE_PATH"
          exit 1
      fi

      echo "üé¨ OVI I2V 10-SECOND (960x960)"
      echo "üì∑ Image: $IMAGE_PATH"
      echo "üìù Prompt: $PROMPT"

      TEMP_CONFIG="/tmp/ovi_i2v_10s_$$.yaml"

      cat > "$TEMP_CONFIG" << EOF
      model_name: "960x960_10s"
      output_dir: "/mnt/output"
      ckpt_dir: "/mnt/models/Ovi"

      sample_steps: 50
      solver_name: "unipc"
      shift: 5.0
      seed: 42

      audio_guidance_scale: 3.0
      video_guidance_scale: 4.0
      slg_layer: 11

      sp_size: 1
      cpu_offload: True
      fp8: True

      mode: "i2v"
      image_prompt: "$IMAGE_PATH"
      text_prompt: "$PROMPT"
      each_example_n_times: 1

      video_negative_prompt: "jitter, bad hands, blur, distortion"
      audio_negative_prompt: "robotic, muffled, echo, distorted"
      EOF

      python3 inference.py --config-file "$TEMP_CONFIG"
      rm -f "$TEMP_CONFIG"

      echo "‚úÖ Done! Check /mnt/output/"
      ls -lh /mnt/output/*.mp4 | tail -3
    mode: '0755'
    owner: ubuntu
    group: ubuntu
  tags: [fix-ovi-helper]

- name: Update test_ovi_quick.sh with correct approach
  copy:
    dest: /mnt/output/test_ovi_quick.sh
    content: |
      #!/bin/bash
      # Quick Ovi Test - Fixed version

      cd /mnt/models/Ovi-code
      source /home/ubuntu/video-generation/venv/bin/activate

      echo "=========================================="
      echo "üé¨ OVI QUICK TEST (FP8 + CPU Offload)"
      echo "=========================================="
      echo ""
      echo "Generating 5-second video with audio..."
      echo ""

      # Use the base config (already has a default prompt)
      python3 inference.py --config-file ovi/configs/inference/inference_24gb.yaml

      echo ""
      echo "=========================================="
      echo "‚úÖ TEST COMPLETE!"
      echo "=========================================="
      ls -lh /mnt/output/*.mp4 | tail -3
      echo "=========================================="
    mode: '0755'
    owner: ubuntu
    group: ubuntu
  tags: [fix-ovi-helper]

- name: Display fix complete message
  debug:
    msg: |
      ==========================================
      ‚úÖ OVI HELPER SCRIPTS READY
      ==========================================

      üìπ TEXT-TO-VIDEO (T2V):
      ~/video-generation/ovi_generate.sh "Prompt. Audio: description"

      üñºÔ∏è IMAGE-TO-VIDEO (I2V) - 5 seconds:
      ~/video-generation/ovi_i2v.sh /path/to/image.png "Prompt. Audio: <S>Speech<E> sounds"

      üñºÔ∏è IMAGE-TO-VIDEO (I2V) - 10 seconds (960x960):
      ~/video-generation/ovi_i2v_10s.sh /path/to/image.png "Prompt. Audio: description"

      üìù PROMPT FORMAT:
      - Speech: <S>Your speech here<E>
      - Audio: Audio: description at end

      üéØ EXAMPLE - Doctor speaking Italian:
      ~/video-generation/ovi_i2v.sh /mnt/output/doctor.png \
        "Doctor in white coat. Audio: <S>Buongiorno, sono il Dottor Rossi<E> Office ambiance"

      ==========================================
  tags: [fix-ovi-helper]
